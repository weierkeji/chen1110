# Chen1110 RL Fault Tolerance System - å®ç°æ€»ç»“

## æ¦‚è¿°

å·²æˆåŠŸå®ç°ä¸€ä¸ªå®Œæ•´çš„å¼ºåŒ–å­¦ä¹ è®­ç»ƒå®¹é”™ç³»ç»Ÿï¼Œå‚è€ƒ DLRover çš„æ¶æ„è®¾è®¡ï¼ŒåŒ…å«ä¸‰å±‚æ¶æ„ï¼šæ•°æ®æ”¶é›†å±‚ã€ç›‘æ§å±‚å’Œè¯Šæ–­ç®¡ç†å±‚ã€‚

## å·²å®Œæˆçš„ç»„ä»¶

### 1. é¡¹ç›®åŸºç¡€ç»“æ„ âœ…

- âœ… **setup.py**: å®Œæ•´çš„æ‰“åŒ…é…ç½®
- âœ… **requirements.txt**: ä¾èµ–åˆ—è¡¨ï¼ˆpsutil, pynvml, requests, torchï¼‰
- âœ… **README.md**: è¯¦ç»†çš„é¡¹ç›®æ–‡æ¡£ï¼ŒåŒ…å«å®‰è£…ã€ä½¿ç”¨ç¤ºä¾‹å’Œ API æ–‡æ¡£
- âœ… **æ‰€æœ‰ __init__.py**: æ‰€æœ‰ç›®å½•çš„åŒ…åˆå§‹åŒ–æ–‡ä»¶

### 2. å…¬å…±ç»„ä»¶ (common/) âœ…

- âœ… **constants.py**: 
  - `DiagnosisConstant`: è¯Šæ–­ç³»ç»Ÿå¸¸é‡
  - `DiagnosisErrorConstant`: é”™è¯¯ç±»å‹å®šä¹‰
  - `DiagnosisDataType`: æ•°æ®ç±»å‹æšä¸¾
  - `DiagnosisActionType`: è¯Šæ–­åŠ¨ä½œç±»å‹
  - `EnvConfigKey`: ç¯å¢ƒå˜é‡é”®
  - `Accelerators`: åŠ é€Ÿå™¨ç±»å‹

- âœ… **diagnosis_data.py**:
  - `GPUStats`: GPUç»Ÿè®¡ä¿¡æ¯
  - `ResourceStats`: èµ„æºç»Ÿè®¡
  - `WorkerTrainingMetric`: è®­ç»ƒæŒ‡æ ‡
  - `DiagnosisObservation`: è¯Šæ–­è§‚å¯Ÿç»“æœ
  - `DiagnosisAction`: è¯Šæ–­åŠ¨ä½œ
  - `NoAction`: æ— åŠ¨ä½œ
  - `NodeAction`: èŠ‚ç‚¹åŠ¨ä½œ
  - `ProcessError`: è¿›ç¨‹é”™è¯¯ä¿¡æ¯

- âœ… **utils.py**:
  - `get_env()`: è·å–ç¯å¢ƒå˜é‡
  - `get_node_id()`, `get_node_type()`, `get_node_rank()`: èŠ‚ç‚¹ä¿¡æ¯
  - `is_port_in_use()`: æ£€æŸ¥ç«¯å£
  - `find_free_port()`: æŸ¥æ‰¾ç©ºé—²ç«¯å£
  - `Singleton`: å•ä¾‹æ¨¡å¼å®ç°

### 3. æ•°æ®æ”¶é›†å±‚ (agent/data_collector/) âœ…

- âœ… **data_collector.py**: 
  - `DataCollector`: æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰ `collect_data()`, `is_enabled()`, `store_data()` æ¥å£

- âœ… **resource_collector.py**: 
  - `ResourceCollector`: æ”¶é›† CPUã€å†…å­˜ã€GPU ä½¿ç”¨æƒ…å†µ
  - è°ƒç”¨ `ResourceMonitor` è¿›è¡Œå®é™…èµ„æºé‡‡é›†

- âœ… **metric_collector.py**: 
  - `MetricCollector`: é€šè¿‡ HTTP ä» XPUTimer æ”¶é›†æ€§èƒ½æŒ‡æ ‡
  - é¢„å¤„ç†å¹¶ä¸ŠæŠ¥æŒ‡æ ‡æ•°æ®

- âœ… **stack_collector.py**: 
  - `StackCollector`: æ”¶é›†è®­ç»ƒè¿›ç¨‹çš„å †æ ˆä¿¡æ¯
  - ç”¨äºæ­»é”å’ŒæŒ‚èµ·è¯Šæ–­

- âœ… **log_collector.py**: 
  - `LogCollector`: æ”¶é›†è®­ç»ƒæ—¥å¿—æ–‡ä»¶å†…å®¹
  - æ”¯æŒå¢é‡è¯»å–å’Œè¡Œæ•°é™åˆ¶

### 4. ç›‘æ§å±‚ (agent/monitor/) âœ…

- âœ… **resource.py**: 
  - `ResourceMonitor`: å•ä¾‹ç±»ï¼Œå‘¨æœŸæ€§ç›‘æ§èµ„æºä½¿ç”¨
  - `get_process_cpu_percent()`: è·å– CPU ä½¿ç”¨ç‡
  - `get_used_memory()`: è·å–å†…å­˜ä½¿ç”¨é‡
  - `get_gpu_stats()`: è·å– GPU ç»Ÿè®¡ä¿¡æ¯
  - ç‹¬ç«‹ç›‘æ§çº¿ç¨‹ï¼Œæ¯ 15 ç§’è‡ªåŠ¨ä¸ŠæŠ¥

- âœ… **training.py**: 
  - `TrainingMonitor`: ç›‘æ§è®­ç»ƒè¿›åº¦
  - `write_training_metrics()`: è¾…åŠ©å‡½æ•°å†™å…¥è®­ç»ƒæŒ‡æ ‡
  - ä» JSON æ–‡ä»¶è¯»å–è®­ç»ƒæ­¥æ•°å¹¶ä¸ŠæŠ¥

### 5. è¯Šæ–­ç®¡ç†å±‚ (controller/) âœ…

- âœ… **diagnosis.py**: 
  - `DiagnosisAgent`: é¡¶å±‚ç¼–æ’å™¨ï¼ˆå•ä¾‹ï¼‰
  - æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰æ•°æ®æ”¶é›†å™¨
  - å‘¨æœŸæ€§æ•°æ®æ”¶é›†çº¿ç¨‹
  - å¿ƒè·³ä¸ŠæŠ¥çº¿ç¨‹
  - `diagnose_training_failure()`: æ•…éšœè¯Šæ–­æ–¹æ³•
  - è‡ªåŠ¨è®¾ç½®é»˜è®¤æ”¶é›†å™¨ï¼ˆResource, Metric, Log, Stackï¼‰

- âœ… **data_manager.py**: 
  - `DiagnosisDataManager`: è¯Šæ–­æ•°æ®ç®¡ç†
  - åŸºäºæ—¶é—´çš„æ•°æ®è¿‡æœŸæœºåˆ¶
  - çº¿ç¨‹å®‰å…¨çš„æ•°æ®å­˜å‚¨å’Œæ£€ç´¢

### 6. æ£€æŸ¥ç‚¹ç®¡ç† (ckpt_manager/) âœ…

- âœ… **latest_checkpoint.py**: 
  - `LatestCheckpointManager`: ç®¡ç†æœ€æ–°æ£€æŸ¥ç‚¹
  - æ”¯æŒå¿«é€Ÿä¿å­˜å’ŒåŠ è½½
  - è‡ªåŠ¨æ¸…ç†æ—§æ£€æŸ¥ç‚¹

- âœ… **periodic_checkpoint.py**: 
  - `PeriodicCheckpointManager`: å‘¨æœŸæ€§æ£€æŸ¥ç‚¹ç®¡ç†
  - å¯é…ç½®çš„ä¿å­˜é—´éš”
  - `save_if_needed()`: æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿å­˜

- âœ… **ref_logp_ckpt.py**: 
  - `RefLogPCheckpointManager`: Reference æ¨¡å‹ LogP æ£€æŸ¥ç‚¹
  - ç”¨äº PPO ç®—æ³•çš„ KL æ•£åº¦è®¡ç®—
  - Episode å’Œ Step ä¸¤çº§ç´¢å¼•

- âœ… **rollout_response_checkpoint.py**: 
  - `RolloutResponseCheckpointManager`: Rollout å“åº”æ£€æŸ¥ç‚¹
  - æ”¯æŒç»éªŒå›æ”¾ç¼“å†²åŒºçš„ä¿å­˜
  - æ‰¹é‡ç®¡ç†å’Œè‡ªåŠ¨æ¸…ç†

### 7. ç¤ºä¾‹å’Œæµ‹è¯• âœ…

- âœ… **examples/basic_usage.py**: 
  - å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
  - æ¼”ç¤ºæ‰€æœ‰ä¸»è¦åŠŸèƒ½

- âœ… **tests/test_basic.py**: 
  - åŸºç¡€å•å…ƒæµ‹è¯•
  - æµ‹è¯•æ•°æ®æ”¶é›†å™¨ã€æ£€æŸ¥ç‚¹ç®¡ç†å™¨ã€å·¥å…·å‡½æ•°

## æ ¸å¿ƒç‰¹æ€§

### ä¸‰å±‚æ¶æ„è®¾è®¡

1. **æ•°æ®æ”¶é›†å±‚ï¼ˆåº•å±‚ï¼‰**: 
   - å®šä¹‰æ•°æ®æ”¶é›†æ¥å£
   - å®ç°å„ç§ç±»å‹çš„æ•°æ®æ”¶é›†å™¨
   - åªè´Ÿè´£æ•°æ®é‡‡é›†é€»è¾‘ï¼Œä¸å…³å¿ƒä½•æ—¶æ‰§è¡Œ

2. **ç›‘æ§å±‚ï¼ˆä¸­é—´å±‚ï¼‰**: 
   - ç‹¬ç«‹è¿è¡Œçš„ç›‘æ§çº¿ç¨‹
   - å‘¨æœŸæ€§é‡‡é›†èµ„æºå’Œè®­ç»ƒæŒ‡æ ‡
   - è‡ªåŠ¨ä¸ŠæŠ¥åˆ° Masterï¼ˆæ¥å£é¢„ç•™ï¼‰

3. **è¯Šæ–­ç®¡ç†å±‚ï¼ˆé¡¶å±‚ï¼‰**: 
   - æ•´åˆæ•°æ®æ”¶é›†å™¨å’Œç›‘æ§å™¨
   - å‘¨æœŸæ€§ä»»åŠ¡è°ƒåº¦
   - æ•…éšœè¯Šæ–­å’Œæ¢å¤ç­–ç•¥

### å…³é”®æŠ€æœ¯ç‚¹

1. **å•ä¾‹æ¨¡å¼**: 
   - `ResourceMonitor`, `TrainingMonitor`, `DiagnosisAgent` ä½¿ç”¨å•ä¾‹
   - ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹

2. **å¤šçº¿ç¨‹è®¾è®¡**: 
   - ç‹¬ç«‹çš„ç›‘æ§çº¿ç¨‹
   - ç‹¬ç«‹çš„æ•°æ®æ”¶é›†çº¿ç¨‹
   - ç‹¬ç«‹çš„å¿ƒè·³ä¸ŠæŠ¥çº¿ç¨‹
   - ä½¿ç”¨ `threading.Lock` ä¿è¯çº¿ç¨‹å®‰å…¨

3. **RL ç‰¹å®šä¼˜åŒ–**: 
   - Actorã€Criticã€Rollout è§’è‰²çš„ç‰¹å®šæ£€æŸ¥ç‚¹ç­–ç•¥
   - Reference æ¨¡å‹çš„ LogP ç®¡ç†
   - Rollout å“åº”çš„æ‰¹é‡ä¿å­˜

4. **çµæ´»çš„é…ç½®**: 
   - ç¯å¢ƒå˜é‡é…ç½®
   - å¯é…ç½®çš„æ—¶é—´é—´éš”
   - å¯é…ç½®çš„æ•°æ®ä¿ç•™ç­–ç•¥

## ä¾èµ–å…³ç³»

```
chen1110 (ç‹¬ç«‹åŒ…)
â”œâ”€â”€ æ ¸å¿ƒä¾èµ–
â”‚   â”œâ”€â”€ psutil>=5.8.0 (èµ„æºç›‘æ§)
â”‚   â”œâ”€â”€ pynvml>=11.0.0 (GPU ç›‘æ§)
â”‚   â”œâ”€â”€ requests>=2.25.0 (HTTP è¯·æ±‚)
â”‚   â””â”€â”€ torch>=1.10.0 (æ£€æŸ¥ç‚¹ç®¡ç†)
â”œâ”€â”€ å¼€å‘ä¾èµ–
â”‚   â”œâ”€â”€ pytest>=7.0.0
â”‚   â”œâ”€â”€ pytest-cov>=3.0.0
â”‚   â”œâ”€â”€ black>=22.0.0
â”‚   â”œâ”€â”€ flake8>=4.0.0
â”‚   â””â”€â”€ mypy>=0.950
â””â”€â”€ å¯é€‰ä¾èµ–
    â””â”€â”€ dlrover>=0.6.0 (ä¸ dlrover é›†æˆ)
```

## ç›®å½•ç»“æ„

```
chen1110/
â”œâ”€â”€ __init__.py                 # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ setup.py                    # æ‰“åŒ…é…ç½®
â”œâ”€â”€ requirements.txt            # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ README.md                   # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md   # å®ç°æ€»ç»“ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ agent/                      # Agent ç«¯ç»„ä»¶
â”‚   â”œâ”€â”€ data_collector/         # æ•°æ®æ”¶é›†å±‚ï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ monitor/                # ç›‘æ§å±‚ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ controller/                 # Controller ç«¯ç»„ä»¶
â”‚   â”œâ”€â”€ diagnosis.py            # è¯Šæ–­ä»£ç†
â”‚   â””â”€â”€ data_manager.py         # æ•°æ®ç®¡ç†å™¨
â”œâ”€â”€ ckpt_manager/               # æ£€æŸ¥ç‚¹ç®¡ç†ï¼ˆ4ä¸ªç®¡ç†å™¨ï¼‰
â”œâ”€â”€ common/                     # å…¬å…±ç»„ä»¶
â”‚   â”œâ”€â”€ constants.py            # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ diagnosis_data.py       # æ•°æ®ç»“æ„
â”‚   â””â”€â”€ utils.py                # å·¥å…·å‡½æ•°
â”œâ”€â”€ examples/                   # ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ basic_usage.py          # åŸºç¡€ç”¨æ³•ç¤ºä¾‹
â””â”€â”€ tests/                      # å•å…ƒæµ‹è¯•
    â””â”€â”€ test_basic.py           # åŸºç¡€æµ‹è¯•
```

## ä½¿ç”¨æ–¹å¼

### 1. å®‰è£…

```bash
cd chen1110
pip install -e .
```

### 2. åŸºç¡€ä½¿ç”¨

```python
from chen1110 import ResourceMonitor, TrainingMonitor, DiagnosisAgent

# å¯åŠ¨èµ„æºç›‘æ§
resource_monitor = ResourceMonitor.singleton_instance()
resource_monitor.start()

# å¯åŠ¨è®­ç»ƒç›‘æ§
training_monitor = TrainingMonitor.singleton_instance(metrics_path="/tmp/metrics.json")
training_monitor.start()

# å¯åŠ¨è¯Šæ–­ä»£ç†
diagnosis_agent = DiagnosisAgent.singleton_instance(training_log_file="/tmp/training.log")
diagnosis_agent.start()
```

### 3. æ£€æŸ¥ç‚¹ç®¡ç†

```python
from chen1110.ckpt_manager import LatestCheckpointManager

ckpt_manager = LatestCheckpointManager(checkpoint_dir="/path/to/checkpoints")
ckpt_manager.save(state_dict, step=global_step)
state_dict = ckpt_manager.load()
```

## ä¸ DLRover çš„å…³ç³»

- **ç‹¬ç«‹è¿è¡Œ**: chen1110 æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Python åŒ…ï¼Œå¯ä»¥å•ç‹¬å®‰è£…å’Œä½¿ç”¨
- **æ¶æ„å‚è€ƒ**: å‚è€ƒäº† DLRover çš„ä¸‰å±‚æ¶æ„è®¾è®¡
- **å¯é€‰é›†æˆ**: å¯ä»¥é€šè¿‡å®‰è£… `dlrover` ä¾èµ–ä¸ DLRover é›†æˆä½¿ç”¨
- **æ¥å£é¢„ç•™**: é¢„ç•™äº†ä¸ Master é€šä¿¡çš„æ¥å£ï¼Œå¯ä»¥å¯¹æ¥åˆ° DLRover Master

## éªŒæ”¶æ ‡å‡†

- âœ… æ‰€æœ‰æ¨¡å—éƒ½æœ‰å®Œæ•´çš„å®ç°
- âœ… å¯ä»¥ç‹¬ç«‹å®‰è£…ä¸º Python åŒ…
- âœ… èƒ½å¤Ÿæ”¶é›†èµ„æºã€æŒ‡æ ‡ã€æ—¥å¿—ã€å †æ ˆæ•°æ®
- âœ… ç›‘æ§çº¿ç¨‹æ­£å¸¸è¿è¡Œå¹¶å®šæœŸæ‰§è¡Œ
- âœ… è¯Šæ–­ä»£ç†èƒ½å¤Ÿæ£€æµ‹å’ŒæŠ¥å‘Šæ•…éšœ
- âœ… æ£€æŸ¥ç‚¹ç®¡ç†æ”¯æŒä¿å­˜å’Œæ¢å¤
- âœ… æœ‰å®Œæ•´çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
- âœ… æœ‰åŸºç¡€çš„å•å…ƒæµ‹è¯•

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®Œå–„æµ‹è¯•**: æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
2. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®æ”¶é›†å’Œæ£€æŸ¥ç‚¹ä¿å­˜çš„æ€§èƒ½
3. **Master é›†æˆ**: å®ç°ä¸ Master çš„å®é™…é€šä¿¡æ¥å£
4. **è¯Šæ–­å™¨å®ç°**: æ·»åŠ æ›´å¤šæ™ºèƒ½è¯Šæ–­å™¨ï¼ˆå¦‚ OOMã€GPU é”™è¯¯ç­‰ï¼‰
5. **æ–‡æ¡£å®Œå–„**: æ·»åŠ æ›´å¤šä½¿ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µ

## æ€»ç»“

chen1110 æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ RL è®­ç»ƒå®¹é”™ç³»ç»Ÿï¼ŒæˆåŠŸå®ç°äº†ï¼š

- ğŸ“Š **å®Œæ•´çš„ç›‘æ§ä½“ç³»**: èµ„æºã€æ€§èƒ½ã€æ—¥å¿—ã€å †æ ˆå…¨è¦†ç›–
- ğŸ”„ **æ™ºèƒ½å®¹é”™æœºåˆ¶**: è‡ªåŠ¨æ£€æµ‹æ•…éšœå¹¶æä¾›æ¢å¤ç­–ç•¥
- ğŸ’¾ **RL ç‰¹å®šçš„æ£€æŸ¥ç‚¹**: æ”¯æŒ Actorã€Criticã€Referenceã€Rollout çš„çŠ¶æ€ç®¡ç†
- ğŸ—ï¸ **æ¸…æ™°çš„æ¶æ„**: ä¸‰å±‚åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®ï¼Œæ˜“äºæ‰©å±•
- ğŸ“¦ **ç‹¬ç«‹çš„åŒ…**: å¯ä»¥ç‹¬ç«‹å®‰è£…å’Œä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸ DLRover é›†æˆ

è¯¥ç³»ç»Ÿä¸ºå¼ºåŒ–å­¦ä¹ è®­ç»ƒæä¾›äº†åšå®çš„å®¹é”™ä¿éšœï¼Œæ˜¾è‘—æé«˜äº†è®­ç»ƒçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

